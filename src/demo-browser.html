<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Audio Network Lite</title>
  <style>
    select, option, .monospace {
      font-family: monospace;
    }
    .section {
      padding-bottom: 15px;
    }
  </style>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body onload="main()">

  <div class="section">
    <select id="transmission-mode" onchange="onTransmissionModeChange(this.value)"></select>
  </div>
  <div id="div-app" style="display: none;">
    <div class="section">
      <b>SampleRate</b>
      <span id="sample-rate"></span> kHz
    </div>
    <div class="section">
      <textarea style="width: 70%; height: 60px;" id="tx-data">0 10 20 30 40 120 250 255</textarea>
    </div>
    <div class="section">
      <button onclick="send('tx-data')">Send</button>
    </div>
    <div class="section">
      <b>Rx Data</b>
    </div>
    <div class="section">
      <span id="rx-data"></span>
    </div>
    <div class="section">
      <button onclick="initializeRxInterval()">Receive</button>
    </div>
  </div>

  <script>
    var dataLinkLayer;
    var rxInterval;
    var txInterval;

    function initializeDataLinkLayer() {
      if (!dataLinkLayer) {
        // AudioNetworkLite.audioMonoIoFactory.audioMonoIoCreateMode = AudioNetworkLite.AudioMonoIoCreateMode.Stub;
        dataLinkLayer = new AudioNetworkLite.DataLinkLayer();
        document.getElementById('sample-rate').innerHTML =
          (dataLinkLayer.physicalLayer.audioMonoIo.getSampleRate() / 1000).toFixed(1);
      }
    }

    function initializeTransmissionModeDropdown() {
      var html = AudioNetworkLite.getDspConfigList().map((dspConfig) => {

        // console.log(dspConfig);
        return '<option value="' + dspConfig.transmissionMode + '">' +
          byteRate(dspConfig.rawByteRate) + ' B/s' +
          ' | ' + kHz(dspConfig.band.begin) + '-' + kHz(dspConfig.band.end) + ' kHz' +
          ' (' + (dspConfig.band.bandwidth / 1000).toFixed(1) + ' kHz' + ')' +
          // ' | ' + dspConfig.transmissionMode +
          '</option>';
      }).join('\n');
      document.getElementById('transmission-mode').innerHTML =
        '<option value="">--- Select Transmission Mode ---</option>\n' + html;
    }

    function kHz(value) {
      const s = (value / 1000).toFixed(1);
      return s.indexOf('.') ===  1 ? '&nbsp;' + s : s;
    }

    function byteRate(value) {
      const s = value.toFixed(1);
      return s.indexOf('.') ===  1 ? '&nbsp;' + s : s;
    }

    function onTransmissionModeChange(transmissionMode) {
      initializeDataLinkLayer();
      if (transmissionMode) {
        dataLinkLayer.physicalLayer.setTransmissionMode(transmissionMode);
        document.getElementById('div-app').style.display = 'block';
        rxInterval && initializeRxInterval();
        txInterval && initializeTxInterval();
      } else {
        document.getElementById('div-app').style.display = 'none';
        clearRxInterval();
        clearTxInterval();
        dataLinkLayer.physicalLayer.audioMonoIo.inputDisable();
        dataLinkLayer.physicalLayer.audioMonoIo.outputDisable();
        document.getElementById('rx-data').innerHTML = '';
      }
    }

    function main() {
      initializeTransmissionModeDropdown();
    }

    function clearRxInterval() {
      clearInterval(rxInterval);
      rxInterval = null;
    }

    function clearTxInterval() {
      clearInterval(txInterval);
      txInterval = null;
    }

    function initializeRxInterval() {
      clearRxInterval();
      rxInterval = setInterval(() => {
        var rxData;
        var rxDataErrorCorrected;

        dataLinkLayer.rxTimeTick();
        rxData = dataLinkLayer.getData();
        rxDataErrorCorrected = dataLinkLayer.getDataErrorCorrected();

        if (rxData || rxDataErrorCorrected) {
          document.getElementById('rx-data').innerHTML =
            document.getElementById('rx-data').innerHTML +
            (rxData ? rxData.map(item => item.join(', ')).join(' | ') : '[none valid] ') +
            (rxDataErrorCorrected ? rxDataErrorCorrected.map(item => item.join(', ')).join(' | ') : '[none error corrected] ') +
            '<br/>';
        }

      }, dataLinkLayer.physicalLayer.getDspConfig().timeTickMillisecondsRx);
    }

    function initializeTxInterval() {
      clearTxInterval();
      txInterval = setInterval(() => {
        if (!dataLinkLayer.txTimeTick()) {
          clearTxInterval();
        }
      }, dataLinkLayer.physicalLayer.getDspConfig().timeTickMillisecondsTx);
    }

    function send(id) {
      var tx = document.getElementById(id).value
        .split(' ')
        .filter((item) => item.trim() !== '')
        .map(item => parseInt(item));

      dataLinkLayer.setData(tx);
      dataLinkLayer.txTimeTick();
      initializeTxInterval();
    }

  </script>
  <!-- you can access distribution version via: <script src="https://unpkg.com/audio-network-lite"></script> -->
</body>
</html>
