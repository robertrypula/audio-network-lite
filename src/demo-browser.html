<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Audio Network Lite</title>
  <style>
    pre {
      white-space: normal;
    }
  </style>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
  <div style="padding-bottom: 20px;" id="div-init">
    <button onclick="init(AudioNetworkLite.TransmissionMode.FatBandFast)">Init - FatBandFast</button>
    <button onclick="init(AudioNetworkLite.TransmissionMode.FatBandSlow)">Init - FatBandSlow</button>
    <button onclick="init(AudioNetworkLite.TransmissionMode.NormalBandFast)">Init - NormalBandFast</button>
    <button onclick="init(AudioNetworkLite.TransmissionMode.NormalBandSlow)">Init - NormalBandSlow</button>
    <button onclick="init(AudioNetworkLite.TransmissionMode.SlimBandFast)">Init - SlimBandFast</button>
    <button onclick="init(AudioNetworkLite.TransmissionMode.SlimBandSlow)">Init - SlimBandSlow</button>
  </div>

  <div id="div-app" style="display: none;">
    <div style="padding-bottom: 20px;">
      <label>Sample Rate</label>
      <pre id="sample-rate"></pre>
      <label>Rx tick</label>
      <pre id="rx-tick"></pre>
      <label>Band</label>
      <pre id="band"></pre>
    </div>

    <div style="padding-bottom: 20px;">
      <textarea style="width: 70%; height: 100px;" id="tx1">0 1 2 3 4 5 6 7 8 9 10 200 201 202 203 204 205 206 207 208 209 210</textarea>
      <br/>
      <button onclick="transmit('tx1')">Transmit</button>
      <br/>
      <textarea style="width: 70%; height: 100px;" id="tx2">0 10 20 30 40 50 60 70 80 90 100 110 120 130 140 150 160 170 180 190 200 210 220 230 240 250 255</textarea>
      <br/>
      <button onclick="transmit('tx2')">Transmit</button>
    </div>
    <div style="padding-bottom: 20px;">
      <div style="padding-bottom: 20px;">
        <button onclick="receive()">Receive</button>
      </div>
      <label>Rx Data (0)</label>
      <pre id="rx-data-0"></pre>
      <label>Rx Data (1)</label>
      <pre id="rx-data-1"></pre>
    </div>
  </div>

  <script>
    var dataLinkLayer;
    var txInterval;

    function init(transmissionMode) {
      AudioNetworkLite.audioMonoIoFactory.audioMonoIoCreateMode = AudioNetworkLite.AudioMonoIoCreateMode.Stub;
      dataLinkLayer = new AudioNetworkLite.DataLinkLayer();
      dataLinkLayer.physicalLayer.setTransmissionMode(transmissionMode);

      console.log(AudioNetworkLite.getDspConfigList());

      document.getElementById('div-app').style.display = 'block';
      document.getElementById('div-init').style.display = 'none';
      document.getElementById('sample-rate').innerHTML = dataLinkLayer.physicalLayer.audioMonoIo.getSampleRate();

      const rxTick = dataLinkLayer.physicalLayer.getRxTimeTickMilliseconds();
      const txTick = dataLinkLayer.physicalLayer.getTxTimeTickMilliseconds();
      document.getElementById('rx-tick').innerHTML = rxTick + ' | ' + (1000 / txTick).toFixed(2) + ' B/s';

      const band = dataLinkLayer.physicalLayer.getDspConfig().band;
      document.getElementById('band').innerHTML = band.begin.toFixed(0) + ' - ' + band.end.toFixed(0) + ' | ' + band.bandwidth.toFixed(0);
    }

    function receive() {
      setInterval(() => {
        var rxData;

        dataLinkLayer.rxTimeTick();
        rxData = dataLinkLayer.getData();
        document.getElementById('rx-data-0').innerHTML = rxData[0].join(', ');
        document.getElementById('rx-data-1').innerHTML = rxData[1].join(', ');
      }, dataLinkLayer.physicalLayer.getRxTimeTickMilliseconds());
    }

    function transmit(id) {
      var tx = document.getElementById(id).value
        .split(' ')
        .filter((item) => item.trim() !== '')
        .map(item => parseInt(item));

      clearInterval(txInterval);
      dataLinkLayer.setData(tx);
      dataLinkLayer.txTimeTick();
      txInterval = setInterval(() => {
        if (!dataLinkLayer.txTimeTick()) {
          clearInterval(txInterval);
        }
      }, dataLinkLayer.physicalLayer.getTxTimeTickMilliseconds());
    }

  </script>
  <!-- you can access distribution version via: <script src="https://unpkg.com/audio-network-lite"></script> -->
</body>
</html>
